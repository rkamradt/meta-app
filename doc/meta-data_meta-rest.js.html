<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: meta-data/meta-rest.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: meta-data/meta-rest.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 *
 * Copyright 2015 Randal L Kamradt Sr.
 *
 * REST router.
 * @module meta-data/meta-rest
 */
/**
 * An internal function that creates a route for
 * a single model
 *
 * @param {Object} app   The Express Object
 * @param {Object} model basic JSON object that describes the model
 * @param {Object} store A store API
 */
var createRoutes = function(app, model, store) {
  var key;
  for(var propName in model.properties) {
    if(model.properties[propName].key) {
      key = model.properties[propName].name;
    }
  }
  if(!key) { // ignore models without keys
    return;
  }
  app.get('/' + model.name, function(req, res) {
    store.findAll(function(err, result) {
      if(err) {
        res.status(500).send(err);
      } else {
        res.status(200).type('json').send(JSON.stringify(result));
      }
      res.end();
    });
  });
  app.get('/' + model.name + '/:id', function(req, res) {
    store.find(req.params.id, function(err, result) {
      if(err) {
        console.log('error in get ' + err);
        res.status(500).send(err);
      } else {
        if(!result) {
          res.status(404);
        } else {
          res.status(200).type('json').send(JSON.stringify(result));
        }
      }
      res.end();
    });
  });
  app.put('/' + model.name + '/:id', function(req, res) {
    var item = JSON.parse(req.body);
    item[key] = req.params.id; // ensure id matches
    store.find(req.params.id, function(err, result) {
      if(err) {
        res.status(500).send(err);
        res.end();
      } else {
        if(!result) {
          res.status(404);
          res.end();
        } else {
          store.remove(req.params.id, function(err, result) {
            if(err) {
              res.status(500).send(err);
              res.end();
            } else {
              store.add(item, function(err, result) {
                if(err) {
                  res.status(500).send(err);
                } else {
                  res.status(200);
                }
                res.end();
              });
            }
          });
        }
      }
    });
  });
  app.post('/' + model.name + '/:id', function(req, res) {
    var item = req.body;
    store.add(item,function(err, result) {
      if(err) {
        res.status(500).send(err);
      } else {
        res.status(200);
      }
      res.end();
    });
  });
  app.delete('/' + model.name + '/:id', function(req, res) {
    store.remove(req.params.id, function(err, result) {
      if(err) {
        res.status(500).send(err);
      } else {
        res.status(200);
      }
      res.end();
    });
  });
};
/**
 * Add routes to Express for a basic rest web service. The
 * web service includes:
 *
 * GET returns the entire data set
 * GET :id returns a single document
 * POST {doc} creates a single document
 * PUT :id {doc} updates a single document
 * DELETE :id deletes a single document
 *
 * It creates routes for each model listed in the input file
 * It also creates a route for getting the meta-data
 *
 * TODO pass in a store factory to account for each model in models
 *
 * @param {Object} app   The Express Object
 * @param {Object} model basic JSON object that describes the models
 * @param {Object} store A store API
 */
module.exports = function(app, models, store) {
  for(var modelName in models.getModels()) {
    console.log('creating Route for model ' + modelName);
    var model = models.getModel(modelName);
    createRoutes(app, model, store);
  }
  app.get('/metadata', function(req, res) {
    res.status(200).type('json').send(JSON.stringify(json));
    res.end();
  });
  app.get('/metadata/:id', function(req, res) {
    var model;
    for(var modelName in models.getModels()) {
      var m = models.getModel(modelName);
      if(m.getName() === req.params.id) {
        model = m;
        break;
      }
    }
    if(!model) {
      res.status(404).type('json');
    } else {
      res.status(200).type('json').send(JSON.stringify(model));
    }
    res.end();
  });
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-index.html">index</a></li><li><a href="module-meta-data_file-storage.html">meta-data/file-storage</a></li><li><a href="module-meta-data_mem-storage.html">meta-data/mem-storage</a></li><li><a href="module-meta-data_meta-create.html">meta-data/meta-create</a></li><li><a href="module-meta-data_meta-rest.html">meta-data/meta-rest</a></li><li><a href="module-meta-data_mongo-storage.html">meta-data/mongo-storage</a></li></ul><h3>Global</h3><ul><li><a href="global.html#apply">apply</a></li><li><a href="global.html#create">create</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta1</a> on Thu Mar 12 2015 09:58:42 GMT-0700 (PDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
